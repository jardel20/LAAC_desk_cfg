#!/bin/bash
# calibracao.sh - SUPER SCRIPT COM MENU CLI (MEM√ìRIA CORRIGIDA)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

VENV_PATH="./.venv/bin/activate"
LOG_FILE="streamlit.log"
PID_FILE="streamlit.pid"
PORT=8501

clear_screen() { clear; }

print_banner() {
    clear_screen
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "         CALIBRA√á√ÉO BANCADAS LED - CONTROLADOR"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "Diret√≥rio: $SCRIPT_DIR"
    echo "Porta:      $PORT"
    echo "URL:        http://localhost:$PORT"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo
}

print_menu() {
    echo "üìã MENU PRINCIPAL:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo " 1. üöÄ Iniciar Streamlit"
    echo " 2. üõë Parar Streamlit"
    echo " 3. ‚ÑπÔ∏è  Status"
    echo " 4. üìä Ver Logs"
    echo " 5. üîÑ Reiniciar"
    echo " 6. üëÄ Monitor (Auto-restart)"
    echo " 7. üìÅ Abrir Pasta Logs"
    echo " 8. üåê Abrir Navegador"
    echo " 0. ‚ùå Sair"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo -n "‚û§ Escolha uma op√ß√£o [0-8]: "
}

# FUN√á√ÉO PARA ABRIR NAVEGADOR
open_browser() {
    local url="http://localhost:$PORT"
    echo "üåê Abrindo navegador: $url"
    
    # Tentar diferentes formas de abrir o navegador
    if command -v xdg-open &> /dev/null; then
        # Linux
        xdg-open "$url" &
        echo "‚úÖ Navegador aberto com xdg-open"
    elif command -v open &> /dev/null; then
        # macOS
        open "$url" &
        echo "‚úÖ Navegador aberto com open"
    elif command -v start &> /dev/null; then
        # Windows (Git Bash, WSL)
        start "$url" &
        echo "‚úÖ Navegador aberto com start"
    elif [ -n "$BROWSER" ]; then
        # Usar navegador definido na vari√°vel BROWSER
        $BROWSER "$url" &
        echo "‚úÖ Navegador aberto com \$BROWSER"
    else
        # Tentar navegadores comuns
        if command -v firefox &> /dev/null; then
            firefox "$url" &
            echo "‚úÖ Navegador aberto: Firefox"
        elif command -v google-chrome &> /dev/null; then
            google-chrome "$url" &
            echo "‚úÖ Navegador aberto: Chrome"
        elif command -v chromium-browser &> /dev/null; then
            chromium-browser "$url" &
            echo "‚úÖ Navegador aberto: Chromium"
        else
            echo "‚ö†Ô∏è  N√£o foi poss√≠vel abrir navegador automaticamente"
            echo "üîó Abra manualmente: $url"
            echo "üìã Copie a URL acima e cole no navegador"
        fi
    fi
}

# FUN√á√ÉO CORRIGIDA PARA MEM√ìRIA
get_memory_mb() {
    local pid=$1
    local rss_bytes
    rss_bytes=$(ps -p $pid -o rss= 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$rss_bytes" ]; then
        echo "scale=1; $rss_bytes / 1024" | bc -l 2>/dev/null | cut -d. -f1
    else
        echo "N/A"
    fi
}

# FUN√á√ÉO PARA VERIFICAR SE SERVIDOR EST√Å PRONTO
wait_for_server() {
    local timeout=30
    local start_time=$(date +%s)
    
    echo "‚è≥ Aguardando servidor iniciar..."
    
    while true; do
        # Verificar se processo est√° rodando
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if ! ps -p $PID > /dev/null 2>&1; then
                echo "‚ùå Processo morreu"
                return 1
            fi
        fi
        
        # Tentar conectar na porta
        if timeout 1 bash -c "cat < /dev/null > /dev/tcp/localhost/$PORT" 2>/dev/null; then
            echo "‚úÖ Servidor pronto!"
            return 0
        fi
        
        # Verificar timeout
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        
        if [ $elapsed -ge $timeout ]; then
            echo "‚ùå Timeout aguardando servidor"
            return 1
        fi
        
        # Mostrar progresso
        echo -n "."
        sleep 1
    done
}

start_server() {
    print_banner
    echo "üöÄ Iniciando Streamlit..."
    
    if [ ! -f "$VENV_PATH" ]; then
        echo "‚ùå Venv n√£o encontrada!"
        echo "Execute: python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
        read -p "Pressione Enter para voltar..."
        return
    fi
    
    echo "üßπ Limpando processos antigos..."
    pkill -f "streamlit run main2.py" 2>/dev/null || true
    
    source "$VENV_PATH"
    
    # CR√çTICO: Desabilitar o browser autom√°tico do Streamlit para evitar duplica√ß√£o
    echo "‚ñ∂Ô∏è  Iniciando servidor (browser autom√°tico DESABILITADO)..."
    nohup streamlit run main.py \
        --server.headless true \
        --browser.gatherUsageStats false \
        --server.port "$PORT" \
        --server.address 0.0.0.0 \
        --server.enableCORS false \
        --server.enableXsrfProtection false > "$LOG_FILE" 2>&1 &
    
    STREAMLIT_PID=$!
    echo $STREAMLIT_PID > "$PID_FILE"
    
    echo "üìä Logs sendo salvos em: $LOG_FILE"
    
    # Aguardar servidor iniciar
    if wait_for_server; then
        echo "‚úÖ Streamlit INICIADO com sucesso! (PID: $STREAMLIT_PID)"
        echo "üì± Acesse: http://localhost:$PORT"
        echo "üåê Abrindo navegador automaticamente..."
        
        # Abrir navegador
        open_browser
        
        # Mostrar tamb√©m IP da rede local
        if command -v hostname &> /dev/null; then
            echo "üåç Acesso na rede: http://$(hostname -I | awk '{print $1}'):$PORT"
        fi
    else
        echo "‚ùå FALHA ao iniciar! Verifique logs:"
        tail -10 "$LOG_FILE"
    fi
    
    read -p "
Pressione Enter para voltar..."
}

stop_server() {
    print_banner
    echo "üõë Parando Streamlit..."
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        echo "Finalizando PID $PID..."
        kill $PID 2>/dev/null && rm -f "$PID_FILE" || echo "PID n√£o encontrado"
    fi
    pkill -f "streamlit run main2.py" 2>/dev/null || true
    echo "‚úÖ Streamlit PARADO!"
    read -p "
Pressione Enter para voltar..."
}

status_server() {
    print_banner
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            MEMORIA=$(get_memory_mb $PID)
            echo "üü¢ RODANDO (PID: $PID)"
            echo "Mem√≥ria: $MEMORIA MB"
            
            # Verificar se porta est√° respondendo
            if timeout 1 bash -c "cat < /dev/null > /dev/tcp/localhost/$PORT" 2>/dev/null; then
                echo "Status: ‚úÖ Ativo e respondendo"
            else
                echo "Status: ‚ö†Ô∏è  Ativo mas n√£o respondendo"
            fi
            
        else
            echo "üî¥ PARADO (PID antigo: $PID)"
            rm -f "$PID_FILE"
        fi
    else
        echo "üî¥ PARADO"
    fi
    if [ -f "$LOG_FILE" ]; then
        echo "Logs: $LOG_FILE $(wc -l < "$LOG_FILE") linhas"
    else
        echo "Logs: $LOG_FILE (0 linhas)"
    fi
    read -p "
Pressione Enter para voltar..."
}

show_logs() {
    print_banner
    if [ -f "$LOG_FILE" ]; then
        echo "üìä √öLTIMOS 20 LOGS:"
        tail -20 "$LOG_FILE"
        echo
        echo "[q] Sair | [Enter] Atualizar | [f] Ver logs completos"
        while true; do
            read -t 1 -n 1 key 2>/dev/null
            if [[ $key == "q" ]]; then
                break
            elif [[ $key == "f" ]]; then
                clear
                echo "üìä LOGS COMPLETOS (Ctrl+C para voltar):"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                tail -100 "$LOG_FILE"
                echo
                echo "Pressione Enter para voltar ao menu..."
                read
                break
            elif [[ -z $key ]]; then
                clear; print_banner
                echo "üìä √öLTIMOS 20 LOGS (Atualizado):"
                tail -20 "$LOG_FILE"
                echo
                echo "[q] Sair | [Enter] Atualizar | [f] Ver logs completos"
            fi
        done
    else
        echo "Nenhum log encontrado."
    fi
    read -p "
Pressione Enter para voltar..."
}

monitor_server() {
    print_banner
    echo "üîÑ MODO MONITOR ATIVO (Auto-restart)"
    echo "‚ö†Ô∏è  Pressione Ctrl+C para parar"
    echo "üì± URL: http://localhost:$PORT"
    echo
    while true; do
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if ! ps -p $PID > /dev/null 2>&1; then
                echo "$(date '+%H:%M:%S'): ‚ö†Ô∏è Streamlit caiu! Reiniciando..."
                start_server
            else
                # Verificar se est√° respondendo
                if ! timeout 1 bash -c "cat < /dev/null > /dev/tcp/localhost/$PORT" 2>/dev/null; then
                    echo "$(date '+%H:%M:%S'): ‚ö†Ô∏è Servidor n√£o responde! Reiniciando..."
                    stop_server
                    sleep 2
                    start_server
                fi
            fi
        else
            echo "$(date '+%H:%M:%S'): üîÑ Iniciando..."
            start_server
        fi
        sleep 30
        clear; print_banner
        echo "üëÄ MONITOR ATIVO - Verificando a cada 30s..."
        echo "üì± URL: http://localhost:$PORT"
        echo "‚ö†Ô∏è  Pressione Ctrl+C para parar"
    done
}

open_logs_dir() {
    if command -v xdg-open &> /dev/null; then
        xdg-open "$SCRIPT_DIR"
    elif command -v open &> /dev/null; then
        open "$SCRIPT_DIR"
    else
        echo "üìÅ Pasta: $SCRIPT_DIR"
        echo "Abra manualmente."
    fi
    read -p "
Pressione Enter para voltar..."
}

# Fun√ß√£o espec√≠fica para abrir navegador
open_browser_menu() {
    print_banner
    echo "üåê Abrir Navegador"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            open_browser
        else
            echo "‚ùå Servidor n√£o est√° rodando!"
            echo "Inicie o servidor primeiro (Op√ß√£o 1)"
        fi
    else
        echo "‚ùå Servidor n√£o est√° rodando!"
        echo "Inicie o servidor primeiro (Op√ß√£o 1)"
    fi
    
    read -p "
Pressione Enter para voltar..."
}

# Fun√ß√£o para iniciar automaticamente
auto_start() {
    print_banner
    echo "‚ö° IN√çCIO AUTOM√ÅTICO"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo "Iniciando servidor e abrindo navegador..."
    echo
    start_server
}

# Verificar se foi chamado com argumento
if [ $# -gt 0 ]; then
    case $1 in
        start)
            start_server
            exit 0
            ;;
        stop)
            stop_server
            exit 0
            ;;
        restart)
            stop_server
            sleep 2
            start_server
            exit 0
            ;;
        status)
            status_server
            exit 0
            ;;
        auto|autostart)
            auto_start
            exit 0
            ;;
        browser)
            open_browser_menu
            exit 0
            ;;
        help|-h|--help)
            echo "Uso: $0 [comando]"
            echo "Comandos:"
            echo "  start      - Iniciar servidor"
            echo "  stop       - Parar servidor"
            echo "  restart    - Reiniciar servidor"
            echo "  status     - Ver status"
            echo "  auto       - Iniciar automaticamente e abrir navegador"
            echo "  browser    - Abrir navegador (se servidor estiver rodando)"
            echo "  help       - Mostrar esta ajuda"
            exit 0
            ;;
    esac
fi

# MAIN LOOP - MENU INTERATIVO
while true; do
    print_banner
    print_menu
    read -r choice
    
    case $choice in
        1|start)
            start_server ;;
        2|stop)
            stop_server ;;
        3|status|st)
            status_server ;;
        4|logs|l|log)
            show_logs ;;
        5|restart|r)
            stop_server
            sleep 2
            start_server ;;
        6|monitor|m|watch)
            monitor_server ;;
        7|dir|folder)
            open_logs_dir ;;
        8|browser|web)
            open_browser_menu ;;
        0|q|quit|exit)
            print_banner
            echo "üëã At√© logo!"
            exit 0 ;;
        *)
            echo "‚ùå Op√ß√£o inv√°lida!"
            sleep 1 ;;
    esac
done